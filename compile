#!/bin/bash

SIZES=(512 1024 2048 4096)

FAST_KERNELS=(
    "Polybench/2DCONV"
    "Polybench/3DCONV"
    "Polybench/ATAX"
    "Polybench/BICG"
)
N_FAST_RUNS=10

SLOW_KERNELS=(
    "Polybench/2MM"
    "Polybench/3MM"
)
N_SLOW_KERNELS=3

# Arguments:
#   - the make target name, e.g. "compile-cpu"
__invoke_make() {
    # fast kernels
    for kernel in "${FAST_KERNELS[@]}"
    do
        for size in "${SIZES[@]}"
        do
            BENCH_NAME=${kernel} SIZE=${size} RUNS=${N_FAST_RUNS} make $1
        done
    done

    # slow kernels
    for kernel in "${SLOW_KERNELS[@]}"
    do
        for size in "${SIZES[@]}"
        do
            BENCH_NAME=${kernel} SIZE=${size} RUNS=${N_SLOW_KERNELS} make $1
        done
    done
}

debug_cpu () {
    __invoke_make "debug"
}

build_cpu () {
    __invoke_make "compile-cpu"
}

build_omp_cpu () {
    __invoke_make "compile-omp-cpu"
}

build_omp_gpu () {
    __invoke_make "compile-omp-gpu"
}

benchmark_cpu () {
    __invoke_make "run-cpu"
}

benchmark_omp_cpu () {
    __invoke_make "run-omp-cpu"
}

benchmark_omp_gpu () {
    __invoke_make "run-omp-gpu"
}

llvm_mca () {
    __invoke_make "llvm-mca"
}

test_all() {
    __invoke_make "test"
}

# usage: ./compile test Polybench/2DCONV
test() {
    kernel="$1"
    BENCH_NAME=${kernel} make test
}

"$@"
